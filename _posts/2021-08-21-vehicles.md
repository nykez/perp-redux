# Vehicles

This week was all about the vehicle system(s) that live in the game-mode. A nice way of putting it: it's a fucking mess. I feel like we been applying band-aids to this system for too long. These band-aids included stuff like photon and vcmod support. Well... no more. 

The first thing I wanted to do is identify all the issues with the system... long story short. It just need a complete rewrite. Nothing was really savable. 

## The data layer
So, I started at the core of it. The data layer. PERP stored vehicles in a way that made sense 10 years ago. It took a string and add delimiters to it and then split that string when it needed to compile/de-compile it. It worked back then. Unfortunately, it doesn't work now. It's not flexible and it's quite slow.

I decided to make use of the relational database we use and modern date serialization -- cough *json*. The new vehicle data tier system uses JSON for modifications (under-glow, hydraulics.. etc). This makes it flexible if we want to remove or add new modifications in the feature. We won't have to rewrite anything like we currently have too. 

Another bad thing about the data system is that it loaded all player's vehicles and it's attributes into memory and stored a reference to it. The player can't use all their vehicles at once, so why? The new system only loads stuff that we really need on a moment's notice. The vehicle id, and the data table (under-glow, hydraulics.. etc). We send this data to the client (vehicle owner) so they're always up to date on what vehicles they have. We also use this in UI -- to make sure we display the correct vehicle color, skin and whatever else we need to in the UI. 

So to finish up the new persistence layer: I decided to make chop-shop, vehicle disabled, and trunks persistent. So... if a player's vehicle gets blown up... it will always be blown up until it's fixed. In the old system the player could simply rejoin. The same goes with the chop-shop. The trunk system is a branch new feature in the game-mode. It will be discussed in another section. 

## Loading Vehicles

Another issue I found right off the back is artifacts of the past. We stored vehicle configurations in whats called a Lua table. Think of it as a collection of information. This collection held stuff like vehicle headlight position, taillight positions, passenger seat configurations... etc. Since VCMod handles this way better than we ever could.. none of this is needed. Every vehicle has many artifacts like this attached to it (we have 200+ vehicles). It was unnecessary memory usage and redundant, We didn't even use it. So, I wrote a little script to remove this useless data and recompile the vehicle configurations into nice, sleek, files. It's great. 

## The Core Issue
So besides the persist layer being shit, and the run-time loading being slow we have still yet to reach our real problem. The core systems! Again, a lot of these systems showed artifacts of the past. It made sense to use it back then but it doesn't now. Such as using con-commands and user-messages before the network library was created in Garry's Mod 13. This needed a complete rewrite. 

Not going to go into full detail, but basically the new system uses a modern approach to handling it. We use net messages where necessary, removed a ton of the networking that we didn't need to network, and unnecessary calls. 

The gamemode would query the database __three__ different times every time a vehicle was spawned.. wtf. With the new persistence layer this wasn't needed. We have all that data loaded in super fast memory. We made use of it. The new system is sleek, readable and fast. 

## UI
The big idea of this rewrite is making everything faster and better without losing the nostalgic perp provides. I wanted to save the dialog used when modifying a vehicle. Because it makes you feel like you're talking to a real person. Unfortunately, it just wasn't worth the pain. Sometimes a player would have to click 4+ times to even get to the section they wanted. We made a centralize (single panel) UI that houses all the customization options.

Another issue was client freezing (sometimes crashing). DModelPanels - a 3d rendering panel in Garry's mod allows a developer to render a model in the UI. It's great.... but it's not great. We tried to load 200+ models at once. It would freeze the client. The process of loading a vehicle is: checking model cache -> if exists then load it -> if not exists then go out to the file system -> load the mdl format (slow) -> cache it. It just doesn't work with 200+ cars. So, we switched to use static icons. It loads in so fast you can't even tell. We added a preview button to view the 3d model + some information. This was a great trade-off from a potential client crashing. 

## Closing / Other
We added Photon to the game mode awhile back. It's now removed. I was never a big fan of Photon and it presents a lot of issues that source1 just can't overcome. I would love to have a photo-realism lighting system one day. We can hope that exists in s&box eventually. 

This was surely a much needed task. It feels great to have a brand new system instead of a duct tapped patched system. It's easier than ever to work with. I am loving it. I am looking forward to building upon the new vehicle features as we progress in the rebuild.

So to wrap up. We rebuilt the data layer, rebuilt the core system, refactored the UI, and added new vehicle modifications -- trunks, colored headlights, custom horns, under glow, hydraulics and skinning. We hope to improve on these systems. I would like to make a progression storage system. Where a player can purchase more trunk slots for their vehicles, and a used car auction house. Maybe! 


- [x] vehicle
- [] inventory <-- next